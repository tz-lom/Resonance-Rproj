context("Test Resonance API")

test_that("Processing done in a good way", {
  
  env <- new.env()
  
  source("../test-resonance-api.R", local = env)
  
  run <- run.online
  
  environment(run) <- env
  
  sinSignal <- matrix(rep(sin(1:63/21*pi*2), 3), ncol=3, byrow = FALSE)
  
  si1 <- SI.channels(3, 21, id=1, name="channels")
  si2 <- SI.event(id=2, name="event")
  blocks <- list(
    DB.channels(si1, nanotime(946729805250000000), sinSignal),
    DB.event(si2, nanotime(946729905250000000), "test")
  )
  
  referenceRun <- list(
    `channels-out` = structure(
      c(0.29475517441090415, 0.56332005806362195, 
        0.7818314824680298, 0.93087374864420414, 0.99720379718118013, 
        0.97492791218182362, 0.86602540378443871, 0.68017273777091969, 
        0.43388373911755823, 0.14904226617617472, -0.14904226617617447, 
        -0.43388373911755801, -0.68017273777091947, -0.86602540378443837, 
        -0.97492791218182362, -0.99720379718118024, -0.93087374864420447, 
        -0.78183148246802991, -0.56332005806362195, -0.29475517441090471, 
        -2.4492935982947064e-16, 0.29475517441090426, 0.56332005806362229, 
        0.78183148246802958, 0.93087374864420425, 0.99720379718118013, 
        0.97492791218182373, 0.86602540378443915, 0.68017273777091924, 
        0.43388373911755845, 0.14904226617617364, -0.14904226617617292, 
        -0.43388373911755779, -0.68017273777091869, -0.86602540378443871, 
        -0.97492791218182351, -0.99720379718118024, -0.93087374864420425, 
        -0.78183148246803014, -0.56332005806362295, -0.29475517441090582, 
        -4.8985871965894128e-16, 0.29475517441090315, 0.56332005806362206, 
        0.78183148246802947, 0.93087374864420447, 0.99720379718118013, 
        0.97492791218182373, 0.86602540378443837, 0.68017273777091936, 
        0.43388373911756023, 0.14904226617617389, -0.14904226617617267, 
        -0.43388373911755757, -0.6801727377709198, -0.86602540378443771, 
        -0.97492791218182351, -0.99720379718118013, -0.93087374864420491, 
        -0.78183148246803025, -0.56332005806362462, -0.29475517441090265, 
        -7.3478807948841188e-16, -0.29475517441090415, -0.56332005806362195, 
        -0.7818314824680298, -0.93087374864420414, -0.99720379718118013, 
        -0.97492791218182362, -0.86602540378443871, -0.68017273777091969, 
        -0.43388373911755823, -0.14904226617617472, 0.14904226617617447, 
        0.43388373911755801, 0.68017273777091947, 0.86602540378443837, 
        0.97492791218182362, 0.99720379718118024, 0.93087374864420447, 
        0.78183148246802991, 0.56332005806362195, 0.29475517441090471, 
        2.4492935982947064e-16, -0.29475517441090426, -0.56332005806362229, 
        -0.78183148246802958, -0.93087374864420425, -0.99720379718118013, 
        -0.97492791218182373, -0.86602540378443915, -0.68017273777091924, 
        -0.43388373911755845, -0.14904226617617364, 0.14904226617617292, 
        0.43388373911755779, 0.68017273777091869, 0.86602540378443871, 
        0.97492791218182351, 0.99720379718118024, 0.93087374864420425, 
        0.78183148246803014, 0.56332005806362295, 0.29475517441090582, 
        4.8985871965894128e-16, -0.29475517441090315, -0.56332005806362206, 
        -0.78183148246802947, -0.93087374864420447, -0.99720379718118013, 
        -0.97492791218182373, -0.86602540378443837, -0.68017273777091936, 
        -0.43388373911756023, -0.14904226617617389, 0.14904226617617267, 
        0.43388373911755757, 0.6801727377709198, 0.86602540378443771, 
        0.97492791218182351, 0.99720379718118013, 0.93087374864420491, 
        0.78183148246803025, 0.56332005806362462, 0.29475517441090265, 
        7.3478807948841188e-16, 0.29475517441090415, 0.56332005806362195, 
        0.7818314824680298, 0.93087374864420414, 0.99720379718118013, 
        0.97492791218182362, 0.86602540378443871, 0.68017273777091969, 
        0.43388373911755823, 0.14904226617617472, -0.14904226617617447, 
        -0.43388373911755801, -0.68017273777091947, -0.86602540378443837, 
        -0.97492791218182362, -0.99720379718118024, -0.93087374864420447, 
        -0.78183148246802991, -0.56332005806362195, -0.29475517441090471, 
        -2.4492935982947064e-16, 0.29475517441090426, 0.56332005806362229, 
        0.78183148246802958, 0.93087374864420425, 0.99720379718118013, 
        0.97492791218182373, 0.86602540378443915, 0.68017273777091924, 
        0.43388373911755845, 0.14904226617617364, -0.14904226617617292, 
        -0.43388373911755779, -0.68017273777091869, -0.86602540378443871, 
        -0.97492791218182351, -0.99720379718118024, -0.93087374864420425, 
        -0.78183148246803014, -0.56332005806362295, -0.29475517441090582, 
        -4.8985871965894128e-16, 0.29475517441090315, 0.56332005806362206, 
        0.78183148246802947, 0.93087374864420447, 0.99720379718118013, 
        0.97492791218182373, 0.86602540378443837, 0.68017273777091936, 
        0.43388373911756023, 0.14904226617617389, -0.14904226617617267, 
        -0.43388373911755757, -0.6801727377709198, -0.86602540378443771, 
        -0.97492791218182351, -0.99720379718118013, -0.93087374864420491, 
        -0.78183148246803025, -0.56332005806362462, -0.29475517441090265, 
        -7.3478807948841188e-16),
      .Dim = c(63L, 3L),
      .StreamInfo = list(
        type = "channels",
        channels = 3L,
        samplingRate = 21
      ),
      TS = new("nanotime", 
               .S3Class = "integer64",
               structure(c(2.2265608329246867e-245, 
                           2.2265608522815263e-245, 2.2265608716383658e-245, 2.2265608909952054e-245, 
                           2.2265609103520449e-245, 2.2265609297088845e-245, 2.226560949065724e-245, 
                           2.2265609684225636e-245, 2.2265609877794031e-245, 2.2265610071362427e-245, 
                           2.2265610264930822e-245, 2.2265610458499218e-245, 2.2265610652067613e-245, 
                           2.2265610845636009e-245, 2.2265611039204405e-245, 2.22656112327728e-245, 
                           2.2265611426341196e-245, 2.2265611619909591e-245, 2.2265611813477987e-245, 
                           2.2265612007046382e-245, 2.2265612200614778e-245, 2.2265612394183173e-245, 
                           2.2265612587751569e-245, 2.2265612781319964e-245, 2.226561297488836e-245, 
                           2.2265613168456756e-245, 2.2265613362025151e-245, 2.2265613555593547e-245, 
                           2.2265613749161942e-245, 2.2265613942730338e-245, 2.2265614136298733e-245, 
                           2.2265614329867129e-245, 2.2265614523435524e-245, 2.226561471700392e-245, 
                           2.2265614910572315e-245, 2.2265615104140711e-245, 2.2265615297709107e-245, 
                           2.2265615491277502e-245, 2.2265615684845898e-245, 2.2265615878414293e-245, 
                           2.2265616071982689e-245, 2.2265616265551084e-245, 2.226561645911948e-245, 
                           2.2265616652687875e-245, 2.2265616846256271e-245, 2.2265617039824666e-245, 
                           2.2265617233393062e-245, 2.2265617426961457e-245, 2.2265617620529853e-245, 
                           2.2265617814098249e-245, 2.2265618007666644e-245, 2.226561820123504e-245, 
                           2.2265618394803435e-245, 2.2265618588371831e-245, 2.2265618781940226e-245, 
                           2.2265618975508622e-245, 2.2265619169077017e-245, 2.2265619362645413e-245, 
                           2.2265619556213808e-245, 2.2265619749782204e-245, 2.22656199433506e-245, 
                           2.2265620136918995e-245, 2.2265620330487391e-245), class = "integer64"))), 
    `event-out` = structure(
      list(
        structure(
          list(
            structure(
              "test", 
              TS = new(
                "nanotime", 
                .S3Class = "integer64",
                structure(2.2266026824123314e-245, class = "integer64")))),
          .StreamInfo = list(
            id = 2,
            name = "event",
            type = "event",
            online = TRUE), 
          TS = new(
            "nanotime", 
            .S3Class = "integer64", 
            structure(numeric(0), class = "integer64")))),
      .StreamInfo = list(
        type = "event")))
  
  expect_success({
    expect_identical(
      run(list(si1, si2), blocks, ""),
      referenceRun
    )
  })
  
})
